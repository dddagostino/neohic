<!doctype html>

<html>
    <head>
        <title>Neovis.js Simple Example</title>
        <style type="text/css">
            html, body {
                font: 16pt arial;
            }

            #viz {
                width: 700px;
                height: 344px;
                border: 1px solid lightgray;
                font: 22pt arial;
            }
        </style>

        <script src="https://code.jquery.com/jquery-3.2.1.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

        <!-- Statistical analysis in JS -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.3/jstat.js"></script>

        <script src="neovis-hic.js"></script>
        <script type="text/javascript">

        var viz;
        var config;
        //var genelist = [];

        var exprgenes ={};
        var exprfile = false;

        function initViz() {
          var res1, res2;
          config = {
                container_id: "viz",
                server_user: "neo4j",
                server_url: "bolt://localhost:7687",
                server_password: "SETPWDHERE",
                labels: {
                    "gene": {
                        "caption": "label"
                    }
                },
                relationships: {
                },
                initial_cypher: "MATCH (n:gene) return n"
            };

            viz = new NeoVis.default(config);

            var exp = document.getElementById('selExp');
            var exp2 = document.getElementById('selExp2');

            viz.performQuery("MATCH (m:experiment) return m").then(
              (response) => {
                response.sort();
                for (var i = 0; i < response.length; i++) {
                    var opt = document.createElement('option');
                    var opt2 = document.createElement('option');
                    opt.value = response[i];
                    opt2.value = response[i];
                    if(i==0) {
                      opt.setAttribute ("selected", "");
                      opt2.setAttribute ("selected", "");
                    }
                    opt.innerHTML = response[i];
                    opt2.innerHTML = response[i];
                    exp.appendChild(opt);
                    exp2.appendChild(opt2);
                    config.relationships[response[i]] ={};
                    config.relationships[response[i]].thickness = "width";
                    config.relationships[response[i]].caption = true;
                    //color qui
                }
                console.log("ALL",config);
              },
              (error) => {console.log(error)} );
        }


        /*********************************************************************/
        function sgenes() {
          var gene2 = document.getElementById('stopGene');
          let exp = document.getElementById('selExp');

          let querystring = "MATCH (n)-[:"+exp.value+"]-() return distinct(n.label) as label ORDER BY label ASC";

          $('#stopGene').hide();
          $('#pathbutton').hide();
          $('#onepathbutton').hide();
//          $('#exprTable').hide();

          viz.performQuery3(querystring).then(
            (response) => {
              $('#stopGene').find('option').remove().end();

              for (var i = 0; i < response.length; i++) {
                var opt = document.createElement('option');
                opt.value = response[i];
                if(i==0) opt.setAttribute ("selected", "");
                opt.innerHTML = response[i];
                gene2.appendChild(opt);
              }
              $('#stopGene').show();
              $('#pathbutton').show();
              $('#onepathbutton').show();
            },
            (error) => {console.log(error)} );
        }


        /*********************************************************************/
        function ggenes() {
          let gene = document.getElementById('selGene');
          let exp = document.getElementById('selExp');

//          $('#exprTable').hide();

          let querystring = "MATCH (n)-[:"+exp.value+"]-() return distinct(n.label) as label ORDER BY label ASC";
          $('#selGene').hide();
          $('#drawbutton').hide();
          sgenes();
          viz.performQuery3(querystring).then(
            (response) => {
              $('#selGene').find('option').remove().end();

              for (var i = 0; i < response.length; i++) {
                var opt = document.createElement('option');
                opt.value = response[i];
                if(i==0) opt.setAttribute ("selected", "");
                opt.innerHTML = response[i];
                gene.appendChild(opt);

              }
              document.getElementById('messagearea').value="Genes: "+querystring;
              $('#selGene').show();
              $('#drawbutton').show();
            },
            (error) => {console.log(error)} );
        }


        /*********************************************************************/
        function grades() {
          let gene = document.getElementById('selGene');
          let exp = document.getElementById('selExp');
          var exp2 = $('#edgeW').val();

          let aover = [];
          let aunder = [];

          let querystring;
          if (document.getElementById('ordG').checked) {
            querystring = "MATCH (n)-[r1:"+exp.value+"]-() WHERE r1.prob >= "+exp2+" return distinct(n.label) as label, count(*) AS count ORDER BY label ASC";
            document.getElementById('messagearea').value="Genes and their grades (order on GRADE): "+querystring;
          } else {
            querystring = "MATCH (n)-[r1:"+exp.value+"]-() WHERE r1.prob >= "+exp2+ " return distinct(n.label) as label, count(*) AS count ORDER BY count DESC, label ASC";
            document.getElementById('messagearea').value="Genes and their grades (order on NAME): "+querystring;
          }
          $('#selGene').hide();
          $('#drawbutton').hide();
          sgenes();
          viz.performQuery3(querystring).then(
            (response) => {
              $('#selGene').find('option').remove().end();

              for (var i = 0; i < response.length; i+=2) {
                var opt = document.createElement('option');
                opt.value = response[i];
                if(i==0) opt.setAttribute ("selected", "");
                opt.innerHTML = response[i]+" - "+response[i+1];
                gene.appendChild(opt);

                if(exprfile) {
                  if(exprgenes.hasOwnProperty(response[i])) {
                    if(exprgenes[response[i]] == true) aover.push(parseFloat(response[i+1]));
                    else aunder.push(parseFloat(response[i+1]));
                  } else console.log(response[i]+" NOT present");
                }
              }

              $('#selGene').show();
              $('#drawbutton').show();

              if(exprfile) {
                let mo = jStat.mean(aover).toFixed(3);
                let stdo = jStat.stdev(aover,true).toFixed(3);
                let no = aover.length;
                let mu = jStat.mean(aunder).toFixed(3);
                let stdu = jStat.stdev(aunder,true).toFixed(3);
                let nu = aunder.length;

                let ttest = (mo-mu)/Math.sqrt( (stdo*stdo)/no + (stdu*stdu)/nu);

                $('#tom').html(mo); $('#toa').html(jStat.variance(aover).toFixed(3));
                $('#tos').html(stdo); $('#tot').html(ttest.toFixed(3));

                $('#tum').html(mu); $('#tua').html(jStat.variance(aunder).toFixed(3));
                $('#tus').html(stdu); $('#pv').html(jStat.ttest(ttest,2).toFixed(3));

                //console.log(no+" "+nu);
                $('#exprTable').show();
              }
              //else $('#exprTable').hide();
            },
            (error) => {console.log(error)} );
        }


        /*********************************************************************/
        function attitude() {
          let gene = document.getElementById('selGene');
          let exp1 = document.getElementById('selExp');
          let exp2 = $('#edgeW').val();
          let querystring;

          let aover = [];
          let aunder = [];

          //$('#selGene').hide();
          $('#drawbutton').hide();
          $('#selGene').find('option').remove().end();
          $('#selGene').append(`<option>Wait...</option>`);
          $('#selGene').show();
/*
          if (document.getElementById('ordG').checked) {
            querystring = "MATCH (n)-[r1:"+exp1.value+"]-()-[r2:"+exp1.value+"]-()-[r3:"+exp1.value+"]-(n) WHERE ";
            querystring = querystring.concat("r1.prob >= "+exp2+" AND r2.prob >= "+exp2+" AND r3.prob >= "+exp2+" return n.label as label, count(*)/2 as count ORDER BY count DESC, label ASC");
            //querystring = "MATCH (n)-[:"+exp.value+"]-()-[:"+exp.value+"]-()-[:"+exp.value+"]-(n) return n.label as label, count(*)/2 as count ORDER BY count DESC, label ASC";
            document.getElementById('messagearea').value="Genes and their attitudes (order on VALUE): "+querystring;
          } else {
            //querystring = "MATCH (n)-[:"+exp.value+"]-()-[:"+exp.value+"]-()-[:"+exp.value+"]-(n) return n.label as label, count(*)/2 as count ORDER BY label ASC";
            querystring = "MATCH (n)-[r1:"+exp1.value+"]-()-[r2:"+exp1.value+"]-()-[r3:"+exp1.value+"]-(n) WHERE ";
            querystring = querystring.concat("r1.prob >= "+exp2+" AND r2.prob >= "+exp2+" AND r3.prob >= "+exp2+" return n.label as label, count(*)/2 as count ORDER BY label ASC");
            document.getElementById('messagearea').value="Genes and their attitudes (order on NAME): "+querystring;
          }
*/
          querystring = "CALL gds.alpha.triangleCount.stream({nodeProjection: 'gene', relationshipProjection: {"+exp1.value+": { ";
          querystring = querystring.concat("type: '"+exp1.value+"', orientation: 'UNDIRECTED'} }, concurrency: 4}) ");
          querystring = querystring.concat("YIELD nodeId, triangles RETURN gds.util.asNode(nodeId).label AS name, triangles ");
          if (document.getElementById('ordG').checked) {
            querystring = querystring.concat("ORDER BY name ASC") ;
            document.getElementById('messagearea').value="Genes and their attitudes (order on NAME): "+querystring;
          }
          else {
            querystring = querystring.concat("ORDER BY triangles DESC");
            document.getElementById('messagearea').value="Genes and their attitudes (order on VALUE): "+querystring;
          }

          console.log(querystring);
          sgenes();
          viz.performQuery3(querystring).then(
           (response) => {
               $('#selGene').find('option').remove().end();
               for (var i = 0; i < response.length; i+=2) {
                 var opt = document.createElement('option');
                 //var a = response[1]/2;
                 opt.value = response[i];
                 if(i==0) opt.setAttribute ("selected", "selected");
                 opt.innerHTML = response[i]+" - "+response[i+1];
                 gene.appendChild(opt);

                 if(exprfile) {
                   if(exprgenes.hasOwnProperty(response[i])) {
                     if(exprgenes[response[i]] == true) aover.push(parseFloat(response[i+1]));
                     else aunder.push(parseFloat(response[i+1]));
                   } else console.log(response[i]+" NOT present");
                 }

               }
               $('#selGene').show();
               $('#drawbutton').show();

               if(exprfile) {
                 let mo = jStat.mean(aover).toFixed(3);
                 let stdo = jStat.stdev(aover,true).toFixed(3);
                 let no = aover.length;
                 let mu = jStat.mean(aunder).toFixed(3);
                 let stdu = jStat.stdev(aunder,true).toFixed(3);
                 let nu = aunder.length;

                 let ttest = (mo-mu)/Math.sqrt( (stdo*stdo)/no + (stdu*stdu)/nu);

                 $('#tom').html(mo); $('#toa').html(jStat.variance(aover).toFixed(3));
                 $('#tos').html(stdo); $('#tot').html(ttest.toFixed(3));

                 $('#tum').html(mu); $('#tua').html(jStat.variance(aunder).toFixed(3));
                 $('#tus').html(stdu); $('#pv').html(jStat.ttest(ttest,2).toFixed(3));

                 console.log(no+" "+nu);
                 $('#exprTable').show();
               }
               //else $('#exprTable').hide();
           },
           (error) => {console.log(error)} );
        }


        /*********************************************************************/
        function findPath(wprop) {
          var gene = document.getElementById('selGene');
          var gene2 = document.getElementById('stopGene');
          let exp = document.getElementById('selExp');

          //$('#exprTable').hide();
/*
          let querystring = "MATCH (n:gene {label: '"+gene2.value+"'}), (end:gene {label: '"+gene.value+"'}) CALL gds.alpha.shortestPath.stream({ nodeProjection: 'gene', ";
          if(wprop==0) {
            querystring +="relationshipProjection: '"+exp.value+"', relationshipProperties: { cost: { property: 'wpath', orientation: 'UNDIRECTED' }}, ";
            querystring +="startNode: n, endNode: end, relationshipWeightProperty: 'cost' }) ";
          } else {
            querystring +="relationshipProjection: '"+exp.value+"', relationshipProperties: { cost: { property: 'link', orientation: 'UNDIRECTED' }}, ";
            querystring +="startNode: n, endNode: end, relationshipWeightProperty: 'cost' }) ";
            ordersp=0;
          }
          querystring +="YIELD nodeId, cost RETURN gds.util.asNode(nodeId).label AS destination";//, cost "
*/
          let querystring = "MATCH (n1 {label: \""+gene2.value+"\"}),(n2 {label: \""+gene.value+"\"}), p = shortestPath((n1)-[:"+exp.value+"*]-(n2)) RETURN p";

          let rell =":"+exp.value;

          console.log("PATH: "+querystring);

          let ind1 = 1;
          let ind2 = 2;
          let querystring2 = "MATCH (n1";
          //viz.performQuery3(querystring).then(
          viz.performQuery2(querystring).then(
            (response) => {
              for (var i = 0; i < response.length; i++) {
                  querystring2 = querystring2.concat(" {label:\""+response[i]+"\"})-[r"+ind1+rell+"]-(n"+ind2);
                  ind1++;
                  ind2++;
              }

              if(response.length === 0) {
                alert("NO PATH EXISTS");
              } else {
                let pos = querystring2.lastIndexOf("-[");
                querystring2 = querystring2.slice(0,pos).concat(" RETURN *");
                console.log("FROM PATH TO "+querystring2);
                viz.renderWithCypher(querystring2);
                document.getElementById('messagearea').value="Path: "+viz._query;
              }

            },
            (error) => {console.log(error)} );
        }


        /*********************************************************************/
        function OneShortestPaths(wprop) {
          let exp = document.getElementById('selExp');
          var gene = document.getElementById('selGene');
          var gene2 = document.getElementById('stopGene');
          $('#selGene').find('option').remove().end();
          let thefirst = 0;

          //$('#exprTable').hide();

          let querystring = "MATCH (n:gene {label: '"+gene2.value+"'}) CALL gds.alpha.shortestPath.deltaStepping.stream({ nodeProjection: 'gene', "
          if(wprop==0) {
            querystring +="relationshipProjection: '"+exp.value+"', relationshipProperties: { wpath: { property: 'wpath', orientation: 'UNDIRECTED' }}, "
            querystring +="startNode: n, relationshipWeightProperty: 'wpath', delta: 3.0 }) "
          } else {
            querystring +="relationshipProjection: '"+exp.value+"', relationshipProperties: { link: { property: 'link', orientation: 'UNDIRECTED' }}, "
            querystring +="startNode: n, relationshipWeightProperty: 'link', delta: 3.0 }) "
          }
          querystring +="YIELD nodeId, distance RETURN gds.util.asNode(nodeId).label AS destination, distance "

          if (document.getElementById('ordG').checked) {
              querystring += "ORDER BY destination, distance";
          } else {
            querystring += "ORDER BY distance, destination";
          }

          console.log(querystring);
          viz.performQuery3(querystring).then(
           (response) => {
               //console.log(response[i],response[i+1]);
               $('#selGene').find('option').remove().end();
               for (var i = 0; i < response.length; i+=2) {
                 if(response[i+1] != "Infinity") {
                  var opt = document.createElement('option');
                  opt.value = response[i];
                  if(thefirst==0) {
                    opt.setAttribute ("selected", "selected");
                    thefirst = 1;
                  }
                  opt.innerHTML = response[i]+" - "+parseFloat(response[i+1]).toFixed( 2 );
                  gene.appendChild(opt);
                 }
               }
               //document.getElementById("selGene").selectedIndex = "0";
               $('#selGene').show();
               $('#drawbutton').show();

               document.getElementById('messagearea').value="OneShortestPaths: "+querystring;
           },
           (error) => {console.log(error)} );
        }


        /*********************************************************************/
        function PageRank() {
          let exp = document.getElementById('selExp');
          var gene = document.getElementById('selGene');
          $('#selGene').find('option').remove().end();

          let aover = [];
          let aunder = [];

          let querystring = "CALL gds.pageRank.stream({ nodeProjection: 'gene', relationshipProjection: '"+exp.value+"',relationshipProperties: { prob: { property: 'prob', orientation: 'UNDIRECTED' }},";
          querystring += "maxIterations: 20, dampingFactor: 0.85, relationshipWeightProperty: 'prob'}) YIELD nodeId, score RETURN gds.util.asNode(nodeId).label AS name, score ";

          if (document.getElementById('ordG').checked) {
              querystring += "ORDER BY name ASC";
          } else {
            querystring += "ORDER BY score DESC, name ASC";
          }

          console.log(querystring);
          viz.performQuery3(querystring).then(
           (response) => {
               //console.log(response[i],response[i+1]);
               $('#selGene').find('option').remove().end();
               for (var i = 0; i < response.length; i+=2) {
                 //console.log(response[i],response[i+1]);
                 var opt = document.createElement('option');
                 opt.value = response[i];
                 if(i==0) opt.setAttribute ("selected", "selected");
                 opt.innerHTML = response[i]+" - "+parseFloat(response[i+1]).toFixed( 3 );
                 gene.appendChild(opt);

                 if(exprfile) {
                   if(exprgenes.hasOwnProperty(response[i])) {
                     if(exprgenes[response[i]] == true) aover.push(parseFloat(response[i+1]));
                     else aunder.push(parseFloat(response[i+1]));
                   } else console.log(response[i]+" NOT present");
                 }
               }
               //document.getElementById("selGene").selectedIndex = "0";
               $('#selGene').show();
               $('#drawbutton').show();

               document.getElementById('messagearea').value="Centrality - PageRank: "+querystring;

               if(exprfile) {
                 let mo = jStat.mean(aover).toFixed(3);
                 let stdo = jStat.stdev(aover,true).toFixed(3);
                 let no = aover.length;
                 let mu = jStat.mean(aunder).toFixed(3);
                 let stdu = jStat.stdev(aunder,true).toFixed(3);
                 let nu = aunder.length;

                 let ttest = (mo-mu)/Math.sqrt( (stdo*stdo)/no + (stdu*stdu)/nu);

                 $('#tom').html(mo); $('#toa').html(jStat.variance(aover).toFixed(3));
                 $('#tos').html(stdo); $('#tot').html(ttest.toFixed(3));

                 $('#tum').html(mu); $('#tua').html(jStat.variance(aunder).toFixed(3));
                 $('#tus').html(stdu); $('#pv').html(jStat.ttest(ttest,2).toFixed(3));

                 //console.log(no+" "+nu);
                 $('#exprTable').show();
               }
               //else $('#exprTable').hide();
           },
           (error) => {console.log(error)} );
        }


        /*********************************************************************/
        function Betweenness() {
          let exp = document.getElementById('selExp');
          var gene = document.getElementById('selGene');
          $('#selGene').find('option').remove().end();

          let aover = [];
          let aunder = [];

          let querystring = "CALL gds.alpha.betweenness.stream({ nodeProjection: 'gene', relationshipProjection: '"+exp.value+"',relationshipProperties: { prob: { property: 'prob', orientation: 'UNDIRECTED' }}";
          querystring += "}) YIELD nodeId, centrality RETURN gds.util.asNode(nodeId).label AS name, centrality ";

          if (document.getElementById('ordG').checked) {
            querystring += "ORDER BY name ASC";
          } else {
            querystring += "ORDER BY centrality DESC, name ASC";
          }

          console.log(querystring);
          viz.performQuery3(querystring).then(
           (response) => {
               //console.log(response[i],response[i+1]);
               $('#selGene').find('option').remove().end();
               for (var i = 0; i < response.length; i+=2) {
                 //console.log(response[i],response[i+1]);
                 var opt = document.createElement('option');
                 opt.value = response[i];
                 if(i==0) opt.setAttribute ("selected", "selected");
                 opt.innerHTML = response[i]+" - "+parseFloat(response[i+1]).toFixed( 3 );
                 gene.appendChild(opt);

                 if(exprfile) {
                   if(exprgenes.hasOwnProperty(response[i])) {
                     if(exprgenes[response[i]] == true) aover.push(parseFloat(response[i+1]));
                     else aunder.push(parseFloat(response[i+1]));
                   } else console.log(response[i]+" NOT present");
                 }
               }
               //document.getElementById("selGene").selectedIndex = "0";
               $('#selGene').show();
               $('#drawbutton').show();

               document.getElementById('messagearea').value="Centrality - Betweenness: "+querystring;

               if(exprfile) {
                 let mo = jStat.mean(aover).toFixed(3);
                 let stdo = jStat.stdev(aover,true).toFixed(3);
                 let no = aover.length;
                 let mu = jStat.mean(aunder).toFixed(3);
                 let stdu = jStat.stdev(aunder,true).toFixed(3);
                 let nu = aunder.length;

                 let ttest = (mo-mu)/Math.sqrt( (stdo*stdo)/no + (stdu*stdu)/nu);

                 $('#tom').html(mo); $('#toa').html(jStat.variance(aover).toFixed(3));
                 $('#tos').html(stdo); $('#tot').html(ttest.toFixed(3));

                 $('#tum').html(mu); $('#tua').html(jStat.variance(aunder).toFixed(3));
                 $('#tus').html(stdu); $('#pv').html(jStat.ttest(ttest,2).toFixed(3));

                 console.log(no+" "+nu);
                 $('#exprTable').show();
               }
               //else $('#exprTable').hide();
           },
           (error) => {console.log(error)} );
        }


        /*********************************************************************/
        function Closeness() {
          let exp = document.getElementById('selExp');
          var gene = document.getElementById('selGene');
          $('#selGene').find('option').remove().end();

          let aover = [];
          let aunder = [];

          let querystring = "CALL gds.alpha.closeness.stream({ nodeProjection: 'gene', relationshipProjection: '"+exp.value+"',relationshipProperties: { prob: { property: 'prob', orientation: 'UNDIRECTED' }}";
          querystring += "}) YIELD nodeId, centrality RETURN gds.util.asNode(nodeId).label AS name, centrality ";

          if (document.getElementById('ordG').checked) {
              querystring += "ORDER BY name ASC";
          } else {
            querystring += "ORDER BY centrality DESC, name ASC";
          }

          console.log(querystring);
          viz.performQuery3(querystring).then(
           (response) => {
               //console.log(response[i],response[i+1]);
               $('#selGene').find('option').remove().end();
               for (var i = 0; i < response.length; i+=2) {
                 //console.log(response[i],response[i+1]);
                 var opt = document.createElement('option');
                 opt.value = response[i];
                 if(i==0) opt.setAttribute ("selected", "selected");
                 opt.innerHTML = response[i]+" - "+parseFloat(response[i+1]).toFixed( 3 );
                 gene.appendChild(opt);

                 if(exprfile) {
                   if(exprgenes.hasOwnProperty(response[i])) {
                     if(exprgenes[response[i]] == true) aover.push(parseFloat(response[i+1]));
                     else aunder.push(parseFloat(response[i+1]));
                   } else console.log(response[i]+" NOT present");
                 }
               }
               //document.getElementById("selGene").selectedIndex = "0";
               $('#selGene').show();
               $('#drawbutton').show();

               document.getElementById('messagearea').value="Centrality - Betweenness: "+querystring;

               if(exprfile) {
                 let mo = jStat.mean(aover).toFixed(3);
                 let stdo = jStat.stdev(aover,true).toFixed(3);
                 let no = aover.length;
                 let mu = jStat.mean(aunder).toFixed(3);
                 let stdu = jStat.stdev(aunder,true).toFixed(3);
                 let nu = aunder.length;

                 let ttest = (mo-mu)/Math.sqrt( (stdo*stdo)/no + (stdu*stdu)/nu);

                 $('#tom').html(mo); $('#toa').html(jStat.variance(aover).toFixed(3));
                 $('#tos').html(stdo); $('#tot').html(ttest.toFixed(3));

                 $('#tum').html(mu); $('#tua').html(jStat.variance(aunder).toFixed(3));
                 $('#tus').html(stdu); $('#pv').html(jStat.ttest(ttest,2).toFixed(3));

                 console.log(no+" "+nu);
                 $('#exprTable').show();
               }
               //else $('#exprTable').hide();
           },
           (error) => {console.log(error)} );
        }


        /*********************************************************************/
        function Jaccard() {
          let exp = document.getElementById('selExp');
          let exp2 = document.getElementById('selExp2');
          var gene = document.getElementById('selGene');
          var txt = document.getElementById('jactxt');

          //$('#exprTable').hide();

          let querystring = "MATCH (g1:gene {label: '"+gene.value+"'})-[:"+exp.value+"]->(gset1) ";
          querystring += "WITH g1, collect(id(gset1)) AS idgset1 ";
          querystring += "MATCH (g2:gene {label: '"+gene.value+"'})-[:"+exp2.value+"]->(gset2) ";
          querystring += "WITH g1, idgset1, g2, collect(id(gset2)) AS idgset2 ";
          //querystring += "RETURN g1.label AS from, g2.label AS to, gds.alpha.similarity.jaccard(idgset1, idgset2) AS similarity;"
          querystring += "RETURN gds.alpha.similarity.jaccard(idgset1, idgset2) AS similarity;"

          console.log(querystring);
          viz.performQuery3(querystring).then(
           (response) => {
             txt.value = parseFloat(response[0]).toFixed( 5 );
             document.getElementById('messagearea').value="Jaccard: "+querystring;
           },
           (error) => {console.log(error)} );
        }


        /*********************************************************************/
        function Louvain() {
          let exp = document.getElementById('selExp');
          var gene = document.getElementById('selGene');

          //$('#exprTable').hide();

          let querystring = "CALL gds.louvain.stream({nodeProjection: 'gene', relationshipProjection: '"+exp.value+"', ";
          querystring += "relationshipProperties: { prob: { property: 'prob', orientation: 'UNDIRECTED' }}, ";
          querystring += "relationshipWeightProperty: 'prob'}) YIELD nodeId, communityId, intermediateCommunityIds ";
          querystring += "RETURN gds.util.asNode(nodeId).label as name, communityId ORDER BY communityId ASC, name ASC";

          console.log(querystring);
          viz.performQuery3(querystring).then(
           (response) => {
               $('#selGene').find('option').remove().end();
               for (var i = 0; i < response.length; i+=2) {
                 var opt = document.createElement('option');
                 opt.value = response[i];
                 if(i==0) opt.setAttribute ("selected", "selected");
                 opt.innerHTML = response[i]+" - "+response[i+1];
                 gene.appendChild(opt);
               }
               $('#selGene').show();
               $('#drawbutton').show();

               document.getElementById('messagearea').value="Louvain: "+querystring;
           },
           (error) => {console.log(error)} );
        }


        /*********************************************************************/
        function readExprFile(event) {
          exprgenes = {};
          exprfile = true;

          var input = event.target;
          var reader = new FileReader();

          reader.onload = function(){
            var text = reader.result;
            var lines = text.split('\n');
            var tt = 0;
            var tres = document.getElementById('expW').value;
            for(var i = 0;i < lines.length;i++){
              let oneline = lines[i].split(' ');
              let v = parseFloat(oneline[2]);
              if (!isNaN(v) && (oneline[1] != "") ) {
                if (v > tres) exprgenes[oneline[1]] = true; //Overexpressed
                else exprgenes[oneline[1]] = false; //Underexpressed
                tt++;
              }
              else console.log("Strange "+lines[i]);
            }

            $('#selGene').find('option').remove().end();
            $('#selGene').append('<option>Read '+lines.length+' lines</option>');
            $('#selGene').append('<option>Found '+tt+' genes</option>');
            $('#selGene').show();

            //let keysSorted = Object.keys(exprgenes).sort();
            //for(var i = 0;i < keysSorted.length;i++) console.log(keysSorted[i]+" "+exprgenes[keysSorted[i]]);
          };
          reader.readAsText(input.files[0]);
        }


        /*********************************************************************/
        function removeExpr() {
          exprgenes = {};
          exprfile = false;
          $("#fileExpr").val('');
          //$('#exprTable').hide();
          $('#selGene').find('option').remove().end();
          $('#selGene').append('<option>Removed the expression values</option>');
          $('#selGene').show();
        }

        function draw() {
          let gene = document.getElementById('selGene');
          var gene2 = document.getElementById('stopGene');
          let exp1 = document.getElementById('selExp');
          var exp2 = $('#edgeW').val();
          let exp3 = document.getElementById('selExp2');
          let msg = $('#messagearea').val();
          let msg2;
          let querystring;

          if ( (msg.search("Genes:") != -1) || (msg.search("Centrality ") != -1) ) {
            $('#edgeWDiv').show();
            querystring = "MATCH (n1 {label: \""+gene.value+"\"})-[r1:"+exp1.value+"]-(n2) WHERE r1.prob >= "+exp2+" RETURN *";
            msg2 = 1;

          } else if (msg.search("Genes and their grades") != -1) {
            $('#edgeWDiv').show();
            querystring = "MATCH (n1 {label: \""+gene.value+"\"})-[r1:"+exp1.value+"]-(n2) WHERE r1.prob >= "+exp2+" RETURN *";
            msg2 = 2;
          }
          else if (msg.search("Genes and their attitudes") != -1) {
            $('#edgeWDiv').show();
            querystring = "MATCH (n1 {label: \""+gene.value+"\"})-[r1:"+exp1.value+"]-(n2)-[r2:"+exp1.value+"]-(n3)-[r3:"+exp1.value+"]-(n1) WHERE ";
            querystring = querystring.concat("r1.prob >= "+exp2+" AND r2.prob >= "+exp2+" AND r3.prob >= "+exp2+" return *");
            msg2 = 3;
          }
          else if (msg.search("Path") != -1) {
            querystring = msg.substr(6);
            msg2 = 4;
          }
          else if (msg.search("OneShortestPaths:") != -1) {
            querystring = "MATCH p=(n1 {label: \""+gene2.value+"\"})-[r:"+exp1.value+"*..3]-(n2 {label: \""+gene.value+"\"})  RETURN nodes(p), relationships(p)";
            viz.renderWithCypher(querystring);
            document.getElementById('messagearea').value="Network: "+viz._query;
            msg2 = 5;
          }
          else if (msg.search("Jaccard:") != -1) {
            $('#edgeWDiv').show();
            querystring = "MATCH (n1 {label: \""+gene.value+"\"})-[r1:"+exp1.value+"|"+exp3.value+"]-(n2) WHERE r1.prob >= "+exp2+" RETURN *";
            msg2 = 6;
          }

          if (msg2 != 5) viz.performQuery(querystring).then(
            (response) => {
              if(response.length > 0) {
                viz.renderWithCypher(querystring);
                if(msg2 == 1) document.getElementById('messagearea').value="Genes: "+viz._query;
                else if(msg2 == 2) document.getElementById('messagearea').value="Genes and their grades: "+viz._query;
                else if(msg2 == 3) document.getElementById('messagearea').value="Genes and their attitudes: "+viz._query;
                else if(msg2 == 4) document.getElementById('messagearea').value="Path: "+viz._query;
                //else if(msg2 == 5) document.getElementById('messagearea').value="Network: "+viz._query;
                else if(msg2 == 6) document.getElementById('messagearea').value="Jaccard: "+viz._query;

              } else {
                window.alert("No edges for "+gene.value+", "+exp1+", "+exp2);
              }
            },
            (error) => {console.log(error)} );
        }


        /*********************************************************************/
        function showElement() {
          let op = document.getElementById('selOp');

          $('#drawbutton').hide();
          $('#exprTable').hide();

          if (op.value >= 10 && op.value < 20 ) {
            $('#stopGeneDiv').show();
            sgenes();
            if (op.value >= 10 && op.value < 15 ) ggenes();
          } else $('#stopGeneDiv').hide();

          if (op.value < 3 ) $('#edgeWDiv').show();
          else {
            $('#edgeWDiv').hide();
            let w = document.getElementById('edgeW');
            w.value = 0.00;
          }

          if (op.value == 31 ) {
            ggenes();
            $('#selExp2Div').show();
            $('#jacdiv').show();
          }
          else {
            $('#selExp2Div').hide();
            $('#jacdiv').hide();
          }

          if (op.value == 41 ) {
            $('#exprDiv').show();
            $('#runDiv').hide();
          } else {
            $('#exprDiv').hide();
            $('#runDiv').show();
          }
        }


        /*********************************************************************/
        function run() {
          let op = document.getElementById('selOp');

          switch (op.value) {
            case "1":
              ggenes();
              break;
            case "2":
              grades();
              break;
            case "3":
              attitude();
              break;
            case "10":
              findPath(1);
              break;
            case "11":
              findPath(0);
              break;
            case "15":
              OneShortestPaths(1);
              break;
            case "16":
              OneShortestPaths(0);
              break;
            case "20":
              PageRank();
              break;
            case "21":
              Betweenness();
              break;
            case "22":
              Closeness();
              break;
            case "31":
              Jaccard();
              break;
            case "32":
              Louvain();
              break;
            //case "41":   useless
            case "42":
              removeExpr();
              break;
          }
        }

    </script>
    </head>
    <body onload="initViz()">

      <div class="col-md-8 col-md-offset-1">
      <BR/><BR/>

      <form id="startform">

        <div class="form-group row">
            <label class="col-md-3 col-form-label" for="inputExperiment">&nbsp;Select an experiment &nbsp;</label>
            <div class="col-md-4">
              <select class="form-control" id="selExp">
              </select>
            </div>
        </div>

        <div class="form-group row">
            <label class="col-md-3 col-form-label" for="inputExperiment">&nbsp;Select an operation &nbsp;</label>
            <div class="col-md-4">
              <select class="form-control" id="selOp" onchange="showElement()">
                <option value="1">Get Genes</option>
                <option value="2">Grades of Genes</option>
                <option value="3">Attitudes of Genes</option>
                <option value="10">Shortest path</option>
                <!--<option value="10">Shortest path - link</option>
                <option value="11">Shortest path - prob</option>-->
                <option value="15">All shortest path - link</option>
                <option value="16">All shortest path - prob</option>
                <option value="20">Centrality: PageRank</option>
                <option value="21">Centrality: Betweenness</option>
                <option value="22">Centrality: Closeness</option>
                <option value="31">Similarity: Jaccard</option>
                <option value="32">Similarity: Louvain</option>
                <option value="41">Load expression values</option>
                <option value="42">Remove expression values</option>
              </select>
            </div>
            <div class="col-md-1" id="jacdiv" style="display:none">
              <input type="text" id="jactxt" name="jactxt" readonly>
            </div>
        </div>

        <div class="form-group row" id="runDiv">
            <label class="col-md-3 col-form-label" for="inputExperiment">&nbsp;Select an order &nbsp;</label>
            <div class="col-md-2 form-check form-check-inline">
              <input type="radio" id="ordG" name="order" value="ordgene" checked>
              <label>Gene</label>
              <input type="radio" id="ordV" name="order" value="ordvalue">
              <label>Value</label>
            </div>
            <div class="col-md-1">
              <button type="button" class="btn btn-primary" id="genebutton" onclick="run()">Run</button>
            </div>
            <div class="col-md-1">
              <button type="button" class="btn btn-primary" id="drawbutton" onclick="draw()" style="display:none">&nbsp;Draw&nbsp;</button>
            </div>

          </div>

          <div class="form-group row" id="stopGeneDiv" style="display:none">
              <label class="col-md-3 col-form-label" for="input2Gene">&nbsp;Starting gene &nbsp;</label>
              <div class="col-md-4">
                <select class="form-control" id="stopGene"></select>
              </div>
          </div>

          <div class="form-group row" id="edgeWDiv" style="display:none">
              <label class="col-md-3 col-form-label" for="inputExperiment">&nbsp;Min. edge prob [0-1] &nbsp;</label>
              <div class="col-md-4">
                <input id="edgeW" type="number" placeholder="0.0" step="0.05" min="0" max="1" value="0.00">
              </div>
          </div>

          <div class="form-group row" id="selExp2Div" style="display:none">
              <label class="col-md-3 col-form-label" for="inputExperiment2">&nbsp;Select another experiment &nbsp;</label>
              <div class="col-md-4">
                <select class="form-control" id="selExp2">
                </select>
              </div>
          </div>

          <div class="form-group row" id="exprDiv" style="display:none">
              <label class="col-md-3 col-form-label" for="inputExperiment">&nbsp;Expression threshold &nbsp;</label>
              <div class="col-md-2">
                <input id="expW" type="number" placeholder="0.0" step="0.05" value="0.00">
              </div>
              <div class="col-md-2">
                <input type="file" id="fileExpr" accept='text/plain' onchange="readExprFile(event)">
              </div>
          </div>



          <div class="form-group row" id="exprTable" style="display:none">
            <div class="col-md-8">
            <table class="table">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Mean</th>
                  <th scope="col">Variance</th>
                  <th scope="col">Stdev</th>
	                <th scope="col">ttest</th>
                  <th scope="col">p-value</th>
                 </tr>
               </thead>
               <tbody>
                 <tr>
                   <th scope="row">Overexpressed</th>
                   <td id="tom"></td>
                   <td id="toa"></td>
                   <td id="tos"></td>
	                 <td id="tot" rowspan="2" style="vertical-align:middle;text-align:center;"></td>
                   <td id="pv" rowspan="2" style="vertical-align:middle;text-align:center;"></td>
                  </tr>
                  <tr>
                    <th scope="row">Underexpressed</th>
                    <td id="tum"></td>
                    <td id="tua"></td>
                    <td id="tus"></td>
                   </tr>
                 </tbody>
               </table>
             </div>
          </div>
<!--
          <div class="form-group row">
            <div class="col-md-1">
              <button type="button" class="btn btn-primary" id="genebutton" onclick="ggenes()">Genes</button>
            </div>

            <div class="col-md-1">
              <button type="button" class="btn btn-primary" id="genebutton" onclick="grades()">Grades</button>
            </div>

            <div class="col-md-1">
              <button type="button" class="btn btn-primary" id="attbutton"  onclick="attitude()">Attitude</button>
            </div>

            <div class="col-md-1">
              <button type="button" class="btn btn-primary" id="drawbutton" onclick="draw()" style="display:none">&nbsp;Draw&nbsp;</button>
            </div>

            <div class="col-md-2">
              <button type="button" class="btn btn-primary" id="pathbutton" onclick="findPath()" style="display:none">&nbsp;&nbsp;Shortest Path&nbsp;&nbsp;</button>
            </div>

            <div class="col-md-2">
              <button type="button" class="btn btn-primary" id="onepathbutton" onclick="OneShortestPaths()" style="display:none">One Shortest Path</button>
            </div>
          </div>

          <div class="form-group row">
            <div class="col-md-2">
              <button type="button" class="btn btn-primary" id="prbutton" onclick="PageRank()">&nbsp;&nbsp;&nbsp;PageRank&nbsp;&nbsp;&nbsp;</button>
            </div>

            <div class="col-md-2">
              <button type="button" class="btn btn-primary" id="bwbutton" onclick="Betweenness()">Betweenness</button>
            </div>

            <div class="col-md-2">
              <button type="button" class="btn btn-primary" id="clbutton" onclick="Closeness()">&nbsp;&nbsp;Closeness&nbsp;&nbsp;</button>
            </div>
          </div>
-->
      </form>
    </div> <!-- Main area -->

      <br>

      <div class="col-md-9 col-md-offset-1">
        <div class="row">
        <div class="col-md-3">
          <select class="form-control" id="selGene" size="20"></select>
        </div>
        <div class="col-md-5">
          <div id="viz"></div>
        </div>
        </div>

        <div class="row">
        <p></p>
        </div>

        <div class="row">
        <div class="col-md-8">
        <textarea id="messagearea" rows="4" cols="150"></textarea>
        </div>
        </div>
      </div>


    </body>
</html>
